# FAP MCP Server

This is the Model Context Protocol (MCP) server for the Flutter Agent Protocol (FAP). It allows AI assistants like Claude Desktop to interact with your Flutter application.

## Prerequisites

*   **Node.js**: v16 or higher.
*   **Flutter App**: A Flutter app running with `fap_agent` installed and initialized.

## Installation

1.  **Install Dependencies**:
    ```bash
    npm install
    ```

2.  **Build the Server**:
    ```bash
    npm run build
    ```

## Configuration

### Option 1: Claude Desktop
Add the following to your `claude_desktop_config.json` (usually located at `~/Library/Application Support/Claude/claude_desktop_config.json` on macOS):

```json
{
  "mcpServers": {
    "flutter-agent": {
      "command": "node",
      "args": [
        "/ABSOLUTE/PATH/TO/YOUR/flutter-ai-testing/fap_mcp/dist/index.js"
      ]
    }
  }
}
```

### Option 2: Claude Code (CLI)
You can configure MCP for the Claude Code CLI in two ways:

1.  **Command Line**:
    ```bash
    claude mcp add flutter-agent -- node /ABSOLUTE/PATH/TO/YOUR/flutter-ai-testing/fap_mcp/dist/index.js
    ```

2.  **Project Config (`.mcp.json`)**:
    Create a `.mcp.json` file in your project root (where you run `claude`):
    ```json
    {
      "mcpServers": {
        "flutter-agent": {
          "command": "node",
          "args": [
            "/ABSOLUTE/PATH/TO/YOUR/flutter-ai-testing/fap_mcp/dist/index.js"
          ]
        }
      }
    }
    ```

**Important**: Replace `/ABSOLUTE/PATH/TO/YOUR/...` with the actual absolute path to the `dist/index.js` file generated by the build step.

### Agent Connection Settings

By default the MCP server tries to connect to `ws://127.0.0.1:9001`. Override this when your Flutter app runs on an emulator, a device, or another machine by exporting one of the following environment variables before launching Claude/Desktop:

| Variable | Description |
| --- | --- |
| `FAP_AGENT_URL` | Full WebSocket URL (easiest). Example: `wss://my-host.example.com:9443`. |
| `FAP_AGENT_HOST` / `FAP_AGENT_PORT` | Host and port that will be combined into `ws://HOST:PORT` (defaults: `127.0.0.1:9001`). |
| `FAP_AGENT_SECURE` | Set to `true` to use `wss://` instead of `ws://` when using host/port. |
| `FAP_AGENT_TIMEOUT_MS` | Optional per-request timeout override. |
| `FAP_SECRET_TOKEN` | Bearer token that must match the Flutter app’s `FapConfig.secretToken`. |

Example:

```bash
export FAP_AGENT_HOST=10.0.2.2
export FAP_AGENT_PORT=9100
export FAP_SECRET_TOKEN=my-shared-secret
claude desktop # or restart Claude Desktop
```

### Config File (no env vars!)

You can also store these settings in `fap_mcp.config.json` (or `.fap_mcp.json`) placed in your project root or `$HOME`. The MCP server automatically loads the first file it finds (or a custom path via `FAP_MCP_CONFIG`).

```json
{
  "agentHost": "10.0.2.2",
  "agentPort": 9100,
  "secretToken": "dev-secret",
  "adbReverse": false
}
```

Keys supported in the config file:

- `agentUrl`: Full `ws://` or `wss://` URL (takes precedence).
- `agentHost` / `agentPort` / `agentSecure`: Build the URL from discrete values.
- `secretToken`: Optional default token (env var still wins if set).
- `adbReverse`: `false` to skip automatic `adb reverse` (enabled by default).

### Automatic detection

When no env vars or config file are provided, the MCP server tries to do the right thing:

1. Attempts `adb reverse tcp:9001 tcp:9001` (unless `FAP_SKIP_ADB_REVERSE=true`) so Android emulators/devices become reachable via `127.0.0.1` without extra setup.
2. Falls back to sensible defaults (`127.0.0.1`, `host.docker.internal`, etc.) depending on the environment. You can override the Docker host via `FAP_DOCKER_HOST`.

In most cases this means you only need to launch your Flutter app with `FapAgent` enabled—no manual wiring required.

## Usage

1.  **Start your Flutter App**: Ensure your app is running and the FAP Agent is listening (default port 9001).
2.  **Restart Claude Desktop**: If it was already open.
3.  **Interact**: You should now see the `flutter-agent` tools (like `list_elements`, `tap`, `enter_text`) available in Claude.

## Tools Available

*   `list_elements`: Get the current UI tree.
*   `tap(selector)`: Tap on a UI element.
*   `enter_text(selector, text)`: Enter text into a field.
*   `set_text(selector, text)`: Replace text in a field (requires focus).
*   `set_selection(selector, base, extent)`: Set cursor selection.
*   `scroll(selector, dx, dy)`: Scroll a view.
*   `drag(selector, dx, dy)`: Drag an element.
*   `long_press(selector)`: Long press an element.
*   `double_tap(selector)`: Double tap an element.
*   `get_route`: Get the current navigation route.
*   `get_logs`: Retrieve app logs.
*   `get_errors`: Retrieve captured errors.
*   `get_performance_metrics`: Retrieve frame timing metrics.
*   `start_recording`: Start recording user interactions.
*   `stop_recording`: Stop recording.
*   `tap_at(x, y)`: Tap at specific screen coordinates (Visual Grounding).
